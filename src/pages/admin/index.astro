---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { PostgresAppointmentService } from '../../lib/database/postgresAppointmentService';
import { Client } from 'pg';
import { StrapiService } from '../../lib/strapi';

// Configurar conexi√≥n a la base de datos
const client = new Client({
  connectionString: process.env.DATABASE_PUBLIC_URL,
});

let appointmentStats = {
  total: 0,
  pending: 0,
  confirmed: 0,
  cancelled: 0,
  completed: 0,
  today: 0,
  thisWeek: 0,
  thisMonth: 0,
};

let blogStats = {
  total: 0,
  published: 0,
  draft: 0,
  categories: 0,
  tags: 0,
};

let systemStats = {
  redisConnected: false,
  socketConnected: false,
  databaseConnected: false,
  strapiConnected: false,
};

try {
  await client.connect();
  const appointmentService = new PostgresAppointmentService(client);

  // Estad√≠sticas de citas
  const appointmentResult = await client.query(`
    SELECT 
      COUNT(*) as total,
      COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending,
      COUNT(CASE WHEN status = 'confirmed' THEN 1 END) as confirmed,
      COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled,
      COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed,
      COUNT(CASE WHEN DATE(appointment_date) = CURRENT_DATE THEN 1 END) as today,
      COUNT(CASE WHEN appointment_date >= CURRENT_DATE - INTERVAL '7 days' THEN 1 END) as this_week,
      COUNT(CASE WHEN appointment_date >= CURRENT_DATE - INTERVAL '30 days' THEN 1 END) as this_month
    FROM appointments
  `);

  if (appointmentResult.rows.length > 0) {
    appointmentStats = appointmentResult.rows[0];
  }

  // Estad√≠sticas del blog
  try {
    const articles = await StrapiService.getArticles();
    const categories = await StrapiService.getCategories();
    const tags = await StrapiService.getTags();

    blogStats = {
      total: articles.length,
      published: articles.filter((a) => a.publishedAt).length,
      draft: articles.filter((a) => !a.publishedAt).length,
      categories: categories.length,
      tags: tags.length,
    };
  } catch (error) {
    console.warn('Error obteniendo estad√≠sticas del blog:', error);
  }

  systemStats.databaseConnected = true;
  systemStats.strapiConnected = true;
} catch (error) {
  console.error('Error conectando a la base de datos:', error);
} finally {
  await client.end();
}

// Verificar estado de Redis y Socket.io
try {
  const redisResponse = await fetch(`${import.meta.env.SITE}/api/cache/status`);
  if (redisResponse.ok) {
    const redisData = await redisResponse.json();
    systemStats.redisConnected = redisData.cache?.redis?.connected || false;
  }
} catch (error) {
  console.warn('Error verificando Redis:', error);
}

try {
  const socketResponse = await fetch(
    `${import.meta.env.SITE}/api/socket/status`
  );
  if (socketResponse.ok) {
    const socketData = await socketResponse.json();
    systemStats.socketConnected = socketData.socket?.ready || false;
  }
} catch (error) {
  console.warn('Error verificando Socket.io:', error);
}
---

<AdminLayout
  title="Dashboard"
  description="Panel de control principal del sistema"
>
  <!-- Welcome Section -->
  <div
    class="admin-card"
    style="margin-bottom: 2rem; padding: 2rem; background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-success) 100%); color: white;"
  >
    <div
      style="display: flex; justify-content: space-between; align-items: center;"
    >
      <div>
        <h2
          style="font-size: 1.875rem; font-weight: 700; margin: 0 0 0.5rem 0;"
        >
          ¬°Bienvenido al Dashboard!
        </h2>
        <p style="margin: 0; opacity: 0.9;">
          Sistema funcionando correctamente - √öltima actualizaci√≥n: {
            new Date().toLocaleString('es-ES')
          }
        </p>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 2rem; font-weight: 700;">üü¢</div>
        <div style="font-size: 0.875rem; opacity: 0.9;">Sistema Activo</div>
      </div>
    </div>
  </div>

  <!-- System Status Cards -->
  <div class="admin-stats-grid">
    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background-color: var(--admin-primary); border-radius: 12px; color: white;"
        >
          <i data-lucide="database" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="admin-badge admin-badge-success">Conectado</div>
      </div>
      <div class="admin-stat-value">
        {systemStats.databaseConnected ? '‚úÖ' : '‚ùå'}
      </div>
      <div class="admin-stat-label">Base de Datos</div>
    </div>

    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background-color: var(--admin-success); border-radius: 12px; color: white;"
        >
          <i data-lucide="zap" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="admin-badge admin-badge-success">Activo</div>
      </div>
      <div class="admin-stat-value">
        {systemStats.redisConnected ? '‚úÖ' : '‚ùå'}
      </div>
      <div class="admin-stat-label">Redis Cache</div>
    </div>

    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background-color: var(--admin-warning); border-radius: 12px; color: white;"
        >
          <i data-lucide="wifi" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="admin-badge admin-badge-success">En L√≠nea</div>
      </div>
      <div class="admin-stat-value">
        {systemStats.socketConnected ? '‚úÖ' : '‚ùå'}
      </div>
      <div class="admin-stat-label">Socket.io</div>
    </div>

    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background-color: var(--admin-error); border-radius: 12px; color: white;"
        >
          <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="admin-badge admin-badge-success">Sincronizado</div>
      </div>
      <div class="admin-stat-value">
        {systemStats.strapiConnected ? '‚úÖ' : '‚ùå'}
      </div>
      <div class="admin-stat-label">Strapi CMS</div>
    </div>
  </div>

  <!-- Main Statistics -->
  <div class="admin-stats-grid">
    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; color: white;"
        >
          <i data-lucide="calendar" style="width: 24px; height: 24px;"></i>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.75rem; color: var(--admin-text-muted);">
            +12%
          </div>
          <div style="font-size: 0.75rem; color: var(--admin-success);">‚Üó</div>
        </div>
      </div>
      <div class="admin-stat-value">{appointmentStats.total}</div>
      <div class="admin-stat-label">Total Citas</div>
    </div>

    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; color: white;"
        >
          <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.75rem; color: var(--admin-text-muted);">
            +5%
          </div>
          <div style="font-size: 0.75rem; color: var(--admin-success);">‚Üó</div>
        </div>
      </div>
      <div class="admin-stat-value">{blogStats.total}</div>
      <div class="admin-stat-label">Art√≠culos</div>
    </div>

    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; color: white;"
        >
          <i data-lucide="clock" style="width: 24px; height: 24px;"></i>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.75rem; color: var(--admin-text-muted);">
            Hoy
          </div>
          <div style="font-size: 0.75rem; color: var(--admin-warning);">‚è∞</div>
        </div>
      </div>
      <div class="admin-stat-value">{appointmentStats.today}</div>
      <div class="admin-stat-label">Citas Hoy</div>
    </div>

    <div class="admin-stat-card">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
      >
        <div
          style="padding: 0.75rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; color: white;"
        >
          <i data-lucide="tag" style="width: 24px; height: 24px;"></i>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.75rem; color: var(--admin-text-muted);">
            Activas
          </div>
          <div style="font-size: 0.75rem; color: var(--admin-primary);">üè∑Ô∏è</div>
        </div>
      </div>
      <div class="admin-stat-value">{blogStats.categories}</div>
      <div class="admin-stat-label">Categor√≠as</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="admin-card" style="margin-bottom: 2rem; padding: 2rem;">
    <h3
      style="font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;"
    >
      <i
        data-lucide="zap"
        style="width: 20px; height: 20px; color: var(--admin-primary);"></i>
      Acciones R√°pidas
    </h3>
    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"
    >
      <a
        href="/admin/appointments"
        class="admin-btn admin-btn-primary"
        style="justify-content: center; text-decoration: none;"
      >
        <i data-lucide="calendar-plus"></i>
        <span>Nueva Cita</span>
      </a>
      <a
        href="/admin/automation"
        class="admin-btn admin-btn-secondary"
        style="justify-content: center; text-decoration: none;"
      >
        <i data-lucide="bot"></i>
        <span>Automatizar</span>
      </a>
      <a
        href="/admin/blog"
        class="admin-btn admin-btn-secondary"
        style="justify-content: center; text-decoration: none;"
      >
        <i data-lucide="edit"></i>
        <span>Nuevo Art√≠culo</span>
      </a>
      <a
        href="/admin/analytics"
        class="admin-btn admin-btn-secondary"
        style="justify-content: center; text-decoration: none;"
      >
        <i data-lucide="bar-chart-3"></i>
        <span>Ver Analytics</span>
      </a>
    </div>
  </div>

  <!-- Recent Activity -->
  <div
    style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;"
  >
    <!-- Recent Appointments -->
    <div class="admin-card" style="padding: 2rem;">
      <h3
        style="font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;"
      >
        <i
          data-lucide="calendar"
          style="width: 20px; height: 20px; color: var(--admin-primary);"></i>
        Citas Recientes
      </h3>
      <div style="space-y: 1rem;">
        <div
          style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--admin-bg); border-radius: 8px; margin-bottom: 0.75rem;"
        >
          <div>
            <div style="font-weight: 500;">Juan P√©rez</div>
            <div style="font-size: 0.875rem; color: var(--admin-text-muted);">
              Consulta General
            </div>
          </div>
          <div class="admin-badge admin-badge-warning">Pendiente</div>
        </div>
        <div
          style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--admin-bg); border-radius: 8px; margin-bottom: 0.75rem;"
        >
          <div>
            <div style="font-weight: 500;">Mar√≠a Garc√≠a</div>
            <div style="font-size: 0.875rem; color: var(--admin-text-muted);">
              Estrategia Digital
            </div>
          </div>
          <div class="admin-badge admin-badge-success">Confirmada</div>
        </div>
        <div
          style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--admin-bg); border-radius: 8px;"
        >
          <div>
            <div style="font-weight: 500;">Carlos L√≥pez</div>
            <div style="font-size: 0.875rem; color: var(--admin-text-muted);">
              Implementaci√≥n IA
            </div>
          </div>
          <div class="admin-badge admin-badge-info">Completada</div>
        </div>
      </div>
      <a
        href="/admin/appointments"
        class="admin-btn admin-btn-secondary"
        style="width: 100%; justify-content: center; margin-top: 1rem; text-decoration: none;"
      >
        <span>Ver Todas las Citas</span>
        <i data-lucide="arrow-right"></i>
      </a>
    </div>

    <!-- System Performance -->
    <div class="admin-card" style="padding: 2rem;">
      <h3
        style="font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;"
      >
        <i
          data-lucide="activity"
          style="width: 20px; height: 20px; color: var(--admin-success);"></i>
        Rendimiento del Sistema
      </h3>
      <div style="space-y: 1.5rem;">
        <div>
          <div
            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"
          >
            <span style="font-size: 0.875rem; color: var(--admin-text-muted);"
              >CPU Usage</span
            >
            <span style="font-size: 0.875rem; font-weight: 500;">23%</span>
          </div>
          <div
            style="width: 100%; height: 8px; background-color: var(--admin-bg); border-radius: 4px; overflow: hidden;"
          >
            <div
              style="width: 23%; height: 100%; background: linear-gradient(90deg, var(--admin-success), #059669);"
            >
            </div>
          </div>
        </div>
        <div>
          <div
            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"
          >
            <span style="font-size: 0.875rem; color: var(--admin-text-muted);"
              >Memory</span
            >
            <span style="font-size: 0.875rem; font-weight: 500;">67%</span>
          </div>
          <div
            style="width: 100%; height: 8px; background-color: var(--admin-bg); border-radius: 4px; overflow: hidden;"
          >
            <div
              style="width: 67%; height: 100%; background: linear-gradient(90deg, var(--admin-warning), #d97706);"
            >
            </div>
          </div>
        </div>
        <div>
          <div
            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"
          >
            <span style="font-size: 0.875rem; color: var(--admin-text-muted);"
              >Disk Space</span
            >
            <span style="font-size: 0.875rem; font-weight: 500;">45%</span>
          </div>
          <div
            style="width: 100%; height: 8px; background-color: var(--admin-bg); border-radius: 4px; overflow: hidden;"
          >
            <div
              style="width: 45%; height: 100%; background: linear-gradient(90deg, var(--admin-primary), #1d4ed8);"
            >
            </div>
          </div>
        </div>
        <div>
          <div
            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"
          >
            <span style="font-size: 0.875rem; color: var(--admin-text-muted);"
              >Network</span
            >
            <span style="font-size: 0.875rem; font-weight: 500;">12%</span>
          </div>
          <div
            style="width: 100%; height: 8px; background-color: var(--admin-bg); border-radius: 4px; overflow: hidden;"
          >
            <div
              style="width: 12%; height: 100%; background: linear-gradient(90deg, var(--admin-success), #059669);"
            >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="admin-chart-container">
    <h3
      style="font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;"
    >
      <i
        data-lucide="trending-up"
        style="width: 20px; height: 20px; color: var(--admin-primary);"></i>
      Tendencias y Analytics
    </h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div>
        <h4
          style="font-size: 1rem; font-weight: 500; margin: 0 0 1rem 0; color: var(--admin-text-muted);"
        >
          Citas por Mes
        </h4>
        <div
          style="height: 200px; background: linear-gradient(135deg, var(--admin-bg) 0%, var(--admin-card) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--admin-text-muted);"
        >
          <div style="text-align: center;">
            <i
              data-lucide="bar-chart-3"
              style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"
            ></i>
            <div>Gr√°fico de Citas</div>
            <div style="font-size: 0.75rem;">Pr√≥ximamente</div>
          </div>
        </div>
      </div>
      <div>
        <h4
          style="font-size: 1rem; font-weight: 500; margin: 0 0 1rem 0; color: var(--admin-text-muted);"
        >
          Art√≠culos Publicados
        </h4>
        <div
          style="height: 200px; background: linear-gradient(135deg, var(--admin-bg) 0%, var(--admin-card) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--admin-text-muted);"
        >
          <div style="text-align: center;">
            <i
              data-lucide="pie-chart"
              style="width: 48px; height: 48px; margin-bottom: 0.5rem; opacity: 0.5;"
            ></i>
            <div>Gr√°fico de Art√≠culos</div>
            <div style="font-size: 0.75rem;">Pr√≥ximamente</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Real-time updates
    function updateDashboard() {
      // Simulate real-time data updates
      const statValues = document.querySelectorAll('.admin-stat-value');
      statValues.forEach((stat) => {
        if (stat.textContent.match(/^\d+$/)) {
          const currentValue = parseInt(stat.textContent);
          const newValue = currentValue + Math.floor(Math.random() * 3) - 1;
          if (newValue >= 0) {
            stat.textContent = newValue;
          }
        }
      });
    }

    // Update dashboard every 30 seconds
    setInterval(updateDashboard, 30000);

    // Add click animations to cards
    document.querySelectorAll('.admin-stat-card').forEach((card) => {
      card.addEventListener('click', function () {
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
          this.style.transform = 'scale(1)';
        }, 150);
      });
    });

    // Show welcome notification
    setTimeout(() => {
      if (window.showNotification) {
        window.showNotification('Dashboard cargado correctamente', 'success');
      }
    }, 1000);
  </script>
</AdminLayout>
