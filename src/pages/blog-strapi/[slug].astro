---
import StrapiBlogLayout from '../../layouts/StrapiBlogLayout.astro';
import { StrapiService } from '../../lib/strapi';
import type { StrapiArticle } from '../../lib/types/strapi';

export const prerender = false; // Usar SSR para Strapi

// Obtener el slug de la URL
const { slug } = Astro.params;

// Obtener el artículo desde Strapi
const article = await StrapiService.getArticle(slug || '');

if (!article) {
  return Astro.redirect('/404');
}

// Preparar props
const pageTitle = article.title;
const description = article.description || article.excerpt || '';
const keywords = article.seo?.keywords?.split(',') || [];
const image = article.cover
  ? `https://strapi.iapunto.com${article.cover.url}`
  : '/images/default-image.jpg';
const author = {
  name: article.author?.name || 'IA Punto',
  description: article.author?.bio || 'Equipo de IA Punto',
  image: article.author?.avatar
    ? `https://strapi.iapunto.com${article.author.avatar.url}`
    : '/images/default-avatar.jpg',
};
const pubDate = article.publishedAt;

// Las variables ya están definidas arriba

// Obtener artículos relacionados
const allArticles = await StrapiService.getArticles();
const sortedArticles = [...allArticles].sort(
  (a, b) =>
    new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime()
);

// Encontrar el índice del artículo actual
const currentIndex = sortedArticles.findIndex(
  (entry) => entry.slug === article.slug
);

// Obtener artículos anterior y siguiente
const prevArticle = sortedArticles[currentIndex - 1] || null;
const nextArticle = sortedArticles[currentIndex + 1] || null;

// Artículos recomendados (últimos 5, excluyendo el actual)
const latestPosts = allArticles
  .filter((a) => a.slug !== article.slug)
  .slice(0, 5);

// Artículo recomendado aleatorio
const recommended = allArticles.filter((a) => a.slug !== article.slug)[
  Math.floor(Math.random() * (allArticles.length - 1))
];

// Frase épica/reflexiva
const quote =
  'El marketing digital y la innovación tecnológica no son un lujo, son el motor que impulsa el crecimiento de las PYMES y startups.';
const quoteAuthor = author.name;

// Categorías y tags para el sidebar
const allCategories = Array.from(
  new Set(allArticles.map((a) => a.category?.name).filter(Boolean))
);
const allTags = Array.from(
  new Set(allArticles.flatMap((a) => a.tags?.map((tag: any) => tag.name) || []))
);
const selectedCategory = article.category?.name || '';
const selectedTags = article.tags?.map((tag: any) => tag.name) || [];
const query = '';
---

<StrapiBlogLayout
  pageTitle={pageTitle}
  description={description}
  keywords={keywords}
  image={image}
  author={author}
  pubDate={pubDate}
  article={article}
>
  <!-- El layout maneja la tabla de contenido automáticamente -->

  <div slot="sidebar">
    <!-- Sidebar con filtros y últimos posts -->
    <div class="space-y-6">
      <!-- Últimos artículos -->
      <div
        class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6"
      >
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
          Últimos artículos
        </h3>
        <div class="space-y-4">
          {
            latestPosts.map((post) => (
              <div class="flex space-x-3">
                {post.cover && (
                  <img
                    src={`https://strapi.iapunto.com${post.cover.url}`}
                    alt={post.title}
                    width="60"
                    height="60"
                    class="w-15 h-15 object-cover rounded"
                  />
                )}
                <div class="flex-1 min-w-0">
                  <a
                    href={`/blog-strapi/${post.slug}`}
                    class="text-sm font-medium text-gray-900 dark:text-white hover:text-primary-600 dark:hover:text-primary-400 line-clamp-2"
                  >
                    {post.title}
                  </a>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    {new Date(post.publishedAt).toLocaleDateString('es-ES')}
                  </p>
                </div>
              </div>
            ))
          }
        </div>
      </div>

      <!-- Categorías -->
      <div
        class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6"
      >
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
          Categorías
        </h3>
        <div class="space-y-2">
          {
            allCategories.map((category) => (
              <a
                href={`/blog-strapi?category=${encodeURIComponent(category)}`}
                class={`block text-sm ${
                  selectedCategory === category
                    ? 'text-primary-600 dark:text-primary-400 font-medium'
                    : 'text-gray-600 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400'
                }`}
              >
                {category}
              </a>
            ))
          }
        </div>
      </div>

      <!-- Tags -->
      <div
        class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6"
      >
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
          Tags
        </h3>
        <div class="flex flex-wrap gap-2">
          {
            allTags.slice(0, 15).map((tag) => (
              <a
                href={`/blog-strapi?tag=${encodeURIComponent(tag)}`}
                class={`text-xs px-2 py-1 rounded border ${
                  selectedTags.includes(tag)
                    ? 'bg-primary-100 text-primary-800 border-primary-200'
                    : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-primary-100 hover:text-primary-800'
                }`}
              >
                #{tag}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </div>

  <!-- El layout maneja el contenido principal automáticamente -->
</StrapiBlogLayout>
