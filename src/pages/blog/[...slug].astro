---
import BlogLayout from '../../layouts/BlogLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { render } from 'astro:content';
import { Image } from 'astro:assets';
import TableOfContents from '../../components/sections/blog/TableOfContents.astro';
import SidebarFilters from '../../components/sections/blog/SidebarFilters.astro';

export const prerender = true;

const blogEntries = await getCollection('blog');
console.log('Slugs detectados:', blogEntries.map(e => e.data.slug));

export async function getStaticPaths() {
  const currentPost = await getCollection('blog');
  return currentPost.map((entry: any) => ({
    params: { slug: entry.data.slug },
    props: {
      post: entry,
      pageTitle: entry.data.title,
      description: entry.data.description,
      keywords: entry.data.keywords,
      image: entry.data.cover,
      author: {
        name: entry.data.author.name,
        description: entry.data.author.description,
        image: entry.data.author.image,
      },
      pubDate: entry.data.pubDate,
    },
  }));
}

const { post, pageTitle, description, keywords, image, author, pubDate } =
  Astro.props;
console.log('Post actual:', post?.data?.slug);
const { Content, content } = await render(post);

// Ordena los posts por fecha (el mismo orden que en el índice del blog)
const sortedPosts = [...blogEntries].sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

// Encuentra el índice del post actual en el array ordenado
const currentIndex = sortedPosts.findIndex((entry) => entry.data.slug === post.data.slug);

// Obtiene los slugs de los posts anterior y siguiente (maneja los casos de límites)
const prevPostSlug = sortedPosts[currentIndex - 1]?.data.slug || null;
const nextPostSlug = sortedPosts[currentIndex + 1]?.data.slug || null;

// Para el sidebar derecho (últimos posts)
const latestPosts = blogEntries.slice(0, 5);
---

<BlogLayout
  pageTitle={pageTitle}
  description={description}
  keywords={keywords}
  image={image}
  author={author}
  pubDate={pubDate}
  post={post}
>
  <TableOfContents html={post.body} slot="toc" />
  <SidebarFilters latestPosts={latestPosts} slot="sidebar" />
  <div>
    <Content />
    <div class="flex justify-between mt-8">
      {prevPostSlug && (
        <a
          href={`/blog/${prevPostSlug}`}
          class="flex items-center justify-center px-4 h-10 ms-0 leading-tight text-gray-500 bg-white border border-1 border-gray-300 rounded-s-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
        >
          <svg
            class="w-5 h-5 inline-block mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Anterior
        </a>
      )}
      <div></div>
      {nextPostSlug && (
        <a
          href={`/blog/${nextPostSlug}`}
          class="flex items-center justify-center px-4 h-10 leading-tight text-gray-500 bg-white border border-gray-300 rounded-e-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
        >
          Siguiente
          <svg
            class="w-5 h-5 inline-block ml-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </a>
      )}
    </div>
  </div>
</BlogLayout>
