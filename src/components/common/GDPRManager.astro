---
// src/components/common/GDPRManager.astro
// Componente para gestionar el consentimiento GDPR de manera avanzada
---

<script>
  // Gestión avanzada del consentimiento GDPR con Google Consent Mode v2
  class GDPRManager {
    constructor() {
      this.init();
    }

    init() {
      // Esperar a que el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () =>
          this.setupEventListeners()
        );
      } else {
        this.setupEventListeners();
      }
    }

    setupEventListeners() {
      // Escuchar cambios en el consentimiento
      document.addEventListener('cookieconsent:change', (event) => {
        this.handleConsentChange(event.detail);
      });

      // Escuchar el primer consentimiento
      document.addEventListener('cookieconsent:first', (event) => {
        this.handleFirstConsent(event.detail);
      });

      // Escuchar actualizaciones de consentimiento
      document.addEventListener('cookieconsent:update', (event) => {
        this.handleConsentUpdate(event.detail);
      });
    }

    handleConsentChange(detail) {
      console.log('Cambio en consentimiento:', detail);

      const { changedCategories, changedServices } = detail;

      // Gestionar cambios en categorías
      if (changedCategories) {
        changedCategories.forEach((category) => {
          this.handleCategoryChange(category);
        });
      }

      // Gestionar cambios en servicios
      if (changedServices) {
        changedServices.forEach((service) => {
          this.handleServiceChange(service);
        });
      }

      // Actualizar Google Consent Mode
      this.updateGoogleConsentMode();
    }

    handleFirstConsent(detail) {
      console.log('Primer consentimiento:', detail);

      // Actualizar Google Consent Mode
      this.updateGoogleConsentMode();

      // Enviar evento de analytics si está habilitado
      if (detail.cookie.acceptedCategories.includes('analytics')) {
        this.trackConsentEvent('first_consent', 'analytics', 'accepted');
      }
    }

    handleConsentUpdate(detail) {
      console.log('Actualización de consentimiento:', detail);

      // Gestionar scripts basado en el consentimiento actual
      this.updateScripts(detail.cookie);

      // Actualizar Google Consent Mode
      this.updateGoogleConsentMode();
    }

    handleCategoryChange(category) {
      switch (category.name) {
        case 'analytics':
          if (category.accepted) {
            this.enableAnalytics();
          } else {
            this.disableAnalytics();
          }
          break;
        case 'marketing':
          if (category.accepted) {
            this.enableMarketing();
          } else {
            this.disableMarketing();
          }
          break;
        default:
          console.log(
            `Categoría ${category.name} cambiada:`,
            category.accepted
          );
      }
    }

    handleServiceChange(service) {
      console.log(`Servicio ${service.name} cambiado:`, service.accepted);

      // Gestionar servicios específicos
      switch (service.name) {
        case 'google_analytics':
          if (service.accepted) {
            this.enableGoogleAnalytics();
          } else {
            this.disableGoogleAnalytics();
          }
          break;
        case 'ahrefs_analytics':
          if (service.accepted) {
            this.enableAhrefsAnalytics();
          } else {
            this.disableAhrefsAnalytics();
          }
          break;
        default:
          console.log(`Servicio ${service.name} no manejado`);
      }
    }

    updateScripts(cookie) {
      // Habilitar/deshabilitar scripts basado en el consentimiento
      if (cookie.acceptedCategories.includes('analytics')) {
        this.enableAnalytics();
      } else {
        this.disableAnalytics();
      }

      if (cookie.acceptedCategories.includes('marketing')) {
        this.enableMarketing();
      } else {
        this.disableMarketing();
      }
    }

    enableAnalytics() {
      console.log('Habilitando analytics...');
      // Los scripts se habilitan automáticamente por la librería
      this.trackConsentEvent('analytics_enabled', 'analytics', 'accepted');
    }

    disableAnalytics() {
      console.log('Deshabilitando analytics...');
      // Limpiar cookies de analytics
      this.clearAnalyticsCookies();
      this.trackConsentEvent('analytics_disabled', 'analytics', 'rejected');
    }

    enableMarketing() {
      console.log('Habilitando marketing...');
      this.trackConsentEvent('marketing_enabled', 'marketing', 'accepted');
    }

    disableMarketing() {
      console.log('Deshabilitando marketing...');
      this.trackConsentEvent('marketing_disabled', 'marketing', 'rejected');
    }

    enableGoogleAnalytics() {
      console.log('Google Analytics habilitado');
      // El script se carga automáticamente
      this.trackConsentEvent('google_analytics_enabled', 'google_analytics', 'accepted');
    }

    disableGoogleAnalytics() {
      console.log('Google Analytics deshabilitado');
      // Limpiar cookies específicas de GA
      this.clearGoogleAnalyticsCookies();
      this.trackConsentEvent('google_analytics_disabled', 'google_analytics', 'rejected');
    }

    enableAhrefsAnalytics() {
      console.log('Ahrefs Analytics habilitado');
      // El script se carga automáticamente
      this.trackConsentEvent('ahrefs_enabled', 'ahrefs_analytics', 'accepted');
    }

    disableAhrefsAnalytics() {
      console.log('Ahrefs Analytics deshabilitado');
      // Limpiar cookies específicas de Ahrefs
      this.clearAhrefsCookies();
      this.trackConsentEvent('ahrefs_disabled', 'ahrefs_analytics', 'rejected');
    }

    updateGoogleConsentMode() {
      // Usar la función global de gtag-init.js
      if (window.updateGoogleConsentMode) {
        window.updateGoogleConsentMode();
      } else {
        console.log('updateGoogleConsentMode no está disponible');
      }
    }

    clearAnalyticsCookies() {
      // Limpiar cookies de analytics
      const cookiesToClear = ['_ga', '_gid', '_gat', '_ga_*', 'ahrefs_*'];

      cookiesToClear.forEach((cookieName) => {
        this.clearCookie(cookieName);
      });
    }

    clearGoogleAnalyticsCookies() {
      const gaCookies = ['_ga', '_gid', '_gat', '_ga_*'];
      gaCookies.forEach((cookie) => {
        this.clearCookie(cookie);
      });
    }

    clearAhrefsCookies() {
      const ahrefsCookies = ['ahrefs_*'];
      ahrefsCookies.forEach((cookie) => {
        this.clearCookie(cookie);
      });
    }

    clearCookie(name) {
      // Limpiar cookie en todos los paths y dominios posibles
      const paths = ['/', '/blog/', '/servicios/', '/acerca-de/', '/contacto/'];
      const domains = [
        window.location.hostname,
        `.${window.location.hostname}`,
      ];

      paths.forEach((path) => {
        domains.forEach((domain) => {
          document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path}; domain=${domain}`;
        });
      });
    }

    trackConsentEvent(action, category, status) {
      // Usar la función global de gtag-init.js
      if (window.trackConsentEvent) {
        window.trackConsentEvent(action, category, status);
      } else {
        // Fallback si la función global no está disponible
        if (window.gtag && this.isAnalyticsEnabled()) {
          window.gtag('event', 'consent_update', {
            event_category: 'gdpr',
            event_label: `${action}_${category}`,
            value: status === 'accepted' ? 1 : 0,
            custom_parameter: {
              consent_action: action,
              consent_category: category,
              consent_status: status
            }
          });
        }
      }
    }

    isAnalyticsEnabled() {
      // Verificar si analytics está habilitado
      try {
        const cookieConsent = window.CookieConsent;
        if (cookieConsent && cookieConsent.getUserPreferences) {
          const preferences = cookieConsent.getUserPreferences();
          return preferences.acceptedCategories.includes('analytics');
        }
      } catch (error) {
        console.log('No se pudo verificar el estado de analytics');
      }
      return false;
    }

    // Método público para obtener el estado del consentimiento
    getConsentStatus() {
      try {
        const cookieConsent = window.CookieConsent;
        if (cookieConsent && cookieConsent.getUserPreferences) {
          return cookieConsent.getUserPreferences();
        }
      } catch (error) {
        console.log('No se pudo obtener el estado del consentimiento');
      }
      return null;
    }

    // Método público para mostrar el modal de preferencias
    showPreferences() {
      try {
        const cookieConsent = window.CookieConsent;
        if (cookieConsent && cookieConsent.showPreferences) {
          cookieConsent.showPreferences();
        }
      } catch (error) {
        console.log('No se pudo mostrar las preferencias');
      }
    }

    // Método para obtener métricas de consentimiento
    getConsentMetrics() {
      try {
        const preferences = this.getConsentStatus();
        if (preferences) {
          return {
            analytics_accepted: preferences.acceptedCategories.includes('analytics'),
            marketing_accepted: preferences.acceptedCategories.includes('marketing'),
            necessary_accepted: preferences.acceptedCategories.includes('necessary'),
            total_categories: preferences.acceptedCategories.length,
            accept_type: preferences.acceptType
          };
        }
      } catch (error) {
        console.log('Error obteniendo métricas de consentimiento:', error);
      }
      return null;
    }
  }

  // Inicializar el gestor de GDPR
  window.GDPRManager = new GDPRManager();
</script>

