---
import { getCollection } from 'astro:content';
// import { CldImage } from "astro-cloudinary";
import FormattedDate from '../../common/FormattedDate.astro'; // Importa el componente FormattedDate
import Card from '../../common/Card.astro';

const allPosts = await getCollection('blog');

// Ordenar por fecha de publicación (más reciente primero)
const sortedPosts = allPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

// Obtener solo los últimos N artículos (ej. los 3 últimos)
const latestPosts = sortedPosts.slice(0, 6);

// Verificar si hay suficientes posts para el carousel
const hasEnoughPosts = latestPosts.length >= 3;
---

<section class="py-20 bg-gradient-to-b from-gray-50 to-white">
  <div class="container w-4/5 py-16 mx-auto px-4">
    <div class="flex items-center pb-16 justify-between mb-12">
      <div class="flex items-center gap-4">
        <h2 class="text-2xl font-bold text-gray-900">Ideas 360</h2>
        <div class="flex items-center h-8">
          <!-- Contenedor para centrar verticalmente -->
          <span class="text-gray-300 text-3xl font-light leading-none mx-1"
            >|</span
          >
        </div>
        <div class="flex items-center h-8">
          <a href="/" class="hover:text-[#D91A60]">
            Noticias e ideas de marketing y desarrollo web
          </a>
        </div>
      </div>
    </div>
    <div class="swiper blog-swiper relative pb-16">
      <div class="swiper-wrapper items-stretch">
        {
          latestPosts.map((entry) => (
            <div class="swiper-slide">
              <Card
                variant="blog"
                image={entry.data.cover}
                alt={entry.data.coverAlt || entry.data.title}
                title={entry.data.title}
                description={entry.data.description}
                category={entry.data.category}
                date={entry.data.pubDate?.toLocaleDateString?.() ?? ''}
                author={entry.data.author?.name}
                authorImage={entry.data.author?.image}
                link={`/blog/${entry.id}`}
              />
            </div>
          ))
        }
      </div>
      <div class="swiper-pagination mt-8 absolute left-0 right-0 bottom-0 z-20"></div>
      <div class="swiper-button-next custom-swiper-nav"></div>
      <div class="swiper-button-prev custom-swiper-nav"></div>
    </div>
  </div>
  <div class="h-16"></div>
  
  <!-- Botón CTA para ir al blog -->
  <div class="flex justify-center mt-2">
    <a
      href="/blog"
      class="inline-flex items-center px-8 py-4 text-lg font-semibold text-white bg-[#E51F52] rounded-lg hover:bg-[#D91A60] transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1"
    >
      <svg
        class="w-5 h-5 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
        />
      </svg>
      Explora Nuestro Blog Completo
    </a>
  </div>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation'; // navigation
  import 'swiper/css/pagination'; // pagination
  
  // Esperar a que el DOM esté completamente cargado
  document.addEventListener('DOMContentLoaded', function() {
    const swiperElement = document.querySelector('.blog-swiper');
    const slides = document.querySelectorAll('.blog-swiper .swiper-slide');
    const hasEnoughPosts = slides.length >= 3;
    
    if (swiperElement) {
      try {
        const blogSwiper = new Swiper('.blog-swiper', {
          modules: [Navigation, Pagination],
          slidesPerView: 3,
          slidesPerGroup: 1,
          spaceBetween: 30,
          loop: hasEnoughPosts, // Solo loop si hay suficientes slides
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
          breakpoints: {
            320: {
              slidesPerView: 1,
              spaceBetween: 10,
            },
            640: {
              slidesPerView: 2,
              spaceBetween: 20,
            },
            1024: {
              slidesPerView: 3,
              spaceBetween: 30,
            },
          },
          // Agregar configuración para evitar comportamientos extraños
          watchOverflow: true,
          observer: true,
          observeParents: true,
        });
        
        // Verificar que el swiper se inicializó correctamente
        if (blogSwiper) {
          console.log('Blog Swiper inicializado correctamente');
        }
      } catch (error) {
        console.error('Error al inicializar Blog Swiper:', error);
      }
    } else {
      console.warn('Elemento .blog-swiper no encontrado');
    }
  });
</script>

<style lang="scss">
  :root {
    --swiper-pagination-color: var(--primary-accent);
    --swiper-pagination-bullet-size: 10px;
    --swiper-pagination-bullet-inactive-color: #7e8083;
  }
  .swiper-pagination {
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    position: absolute;
    left: 0;
    right: 0;
    bottom: -2.5rem;
    z-index: 20;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .swiper-wrapper {
    align-items: stretch;
  }
  .swiper-slide {
    display: flex;
    height: auto;
  }
  article {
    height: 100%;
    min-height: 540px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .blog-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: black;
    transition: color 0.3s;
  }
  .blog-card-title-link {
    text-decoration: none;
    color: inherit;
  }
  .blog-card-title-link:hover .blog-card-title {
    color: #d91a60;
  }
  .custom-swiper-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 30;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(90deg, rgba(229,31,82,0.7) 60%, rgba(229,31,82,0) 100%);
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
    opacity: 0.85;
  }
  .swiper-button-next.custom-swiper-nav {
    right: 0.5rem;
    left: auto;
    background: linear-gradient(270deg, rgba(229,31,82,0.7) 60%, rgba(229,31,82,0) 100%);
  }
  .swiper-button-prev.custom-swiper-nav {
    left: 0.5rem;
    right: auto;
    background: linear-gradient(90deg, rgba(229,31,82,0.7) 60%, rgba(229,31,82,0) 100%);
  }
  .custom-swiper-nav::after {
    font-size: 1.5rem;
    font-weight: bold;
  }
</style>
