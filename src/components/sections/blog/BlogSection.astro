---
import { StrapiService } from '../../../lib/strapi';
import FormattedDate from '../../common/FormattedDate.astro';
import Card from '../../common/Card.astro';

// Obtener artÃ­culos desde Strapi
const articles = await StrapiService.getArticles();

// Convertir datos de Strapi al formato esperado por el componente
const latestPosts = articles.slice(0, 6).map((article) => ({
  data: {
    slug: article.slug,
    title: article.title,
    description: article.description || article.excerpt || '',
    category: article.category?.name || '',
    pubDate: new Date(article.publishedAt),
    cover: article.cover
      ? `https://strapi.iapunto.com${article.cover.url}`
      : '',
    coverAlt: article.coverAlt || article.title,
    epicQuote: article.epicQuote || '',
    author: {
      name: article.author?.name || 'IA Punto',
      image: article.author?.avatar
        ? `https://strapi.iapunto.com${article.author.avatar.url}`
        : '/images/default-avatar.jpg',
    },
  },
  id: article.slug, // Usar slug como ID para el enlace
}));

// Verificar si hay suficientes posts para el carousel
const hasEnoughPosts = latestPosts.length >= 3;
---

<link rel="stylesheet" href="/styles/splide.min.css" />

<section class="py-20 bg-gradient-to-b from-gray-50 to-white">
  <div class="container w-4/5 py-16 mx-auto px-4">
    <div class="flex items-center pb-16 justify-between mb-12">
      <div class="flex items-center gap-4">
        <h2 class="text-2xl font-bold text-gray-900">Ideas 360</h2>
        <div class="flex items-center h-8">
          <span class="text-gray-300 text-3xl font-light leading-none mx-1"
            >|</span
          >
        </div>
        <div class="flex items-center h-8">
          <a href="/" class="hover:text-[#D91A60]">
            Noticias e ideas de marketing y desarrollo web
          </a>
        </div>
      </div>
    </div>
    <div id="blog-splide" class="splide relative pb-16">
      <div class="splide__track">
        <ul class="splide__list">
          {
            latestPosts.map((entry) => (
              <li class="splide__slide">
                <Card
                  variant="blog"
                  image={entry.data.cover}
                  alt={entry.data.coverAlt || entry.data.title}
                  title={entry.data.title}
                  description={entry.data.description}
                  epicQuote={entry.data.epicQuote}
                  category={entry.data.category}
                  date={entry.data.pubDate?.toLocaleDateString?.() ?? ''}
                  author={entry.data.author?.name}
                  authorImage={entry.data.author?.image}
                  link={`/blog/${entry.data.slug}`}
                />
              </li>
            ))
          }
        </ul>
      </div>
    </div>
  </div>
  <div class="h-16"></div>
  <div class="flex justify-center mt-2">
    <a
      href="/blog"
      class="inline-flex items-center px-8 py-4 text-lg font-semibold text-white bg-[#E51F52] rounded-lg hover:bg-[#D91A60] transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1"
    >
      <svg
        class="w-5 h-5 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
        ></path>
      </svg>
      Explora Nuestro Blog Completo
    </a>
  </div>
</section>

<script src="/scripts/splide.min.js" is:inline></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    new Splide('#blog-splide', {
      type: 'loop',
      perPage: 3,
      perMove: 1,
      gap: 30,
      arrows: true,
      pagination: true,
      autoplay: true,
      interval: 3500,
      pauseOnHover: true,
      pauseOnFocus: true,
      speed: 600,
      breakpoints: {
        1024: { perPage: 2, perMove: 1, gap: 20 },
        640: { perPage: 1, perMove: 1, gap: 10 },
      },
      classes: {
        arrows: 'splide__arrows flex justify-center gap-4 mt-4',
        arrow:
          'splide__arrow bg-primary-600 text-white rounded-full w-10 h-10 flex items-center justify-center',
        pagination: 'splide__pagination flex justify-center gap-2 mt-6',
        page: 'splide__pagination__page bg-gray-300 rounded-full w-3 h-3',
      },
    }).mount();
  });
</script>

<style>
  .splide__slide {
    display: flex;
    height: auto;
    justify-content: center;
  }
  article {
    height: 100%;
    min-height: 540px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .blog-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: black;
    transition: color 0.3s;
  }
  .blog-card-title-link {
    text-decoration: none;
    color: inherit;
  }
  .blog-card-title-link:hover .blog-card-title {
    color: #d91a60;
  }
  .splide__arrows,
  .splide__arrow {
    display: flex !important;
  }
  .splide__pagination__page.is-active {
    background: #e51f52;
  }
</style>
