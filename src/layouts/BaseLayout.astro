---
// src/layouts/BaseLayout.astro
// Layout base reutilizable con variantes para diferentes tipos de páginas

import BaseHead from '../components/common/BaseHead.astro';
import TopBar from '../components/layout/Header/TopBar.astro';
import Navbar from '../components/layout/Header/Navbar.astro';
import Footer from '../components/layout/Footer.astro';
import BackToTop from '../components/layout/BackToTop.astro';
import Breadcrumb from '../components/layout/Header/Breadcrumb.astro';
import TrackingScripts from '../components/common/TrackingScripts.astro';
import WhatsAppButton from '../components/layout/WhatsAppButton.astro';
import GDPRManager from '../components/common/GDPRManager.astro';
import GoogleConsentMode from '../components/common/GoogleConsentMode.astro';
import MeetingWizard from '../components/common/MeetingWizard.astro';

export interface Props {
  // Props básicas
  pageTitle: string;
  description?: string;
  image?: string;
  keywords?: string;
  robots?: string;

  // Props para Footer
  ctaTitle?: string;
  ctaDescription?: string;
  ctaButtonText?: string;
  ctaButtonHref?: string;

  // Variantes del layout
  variant?: 'default' | 'blog' | 'legal';
  showBreadcrumb?: boolean;
  showBackToTop?: boolean;
  showWhatsApp?: boolean;
  showTracking?: boolean;
  showRecaptcha?: boolean;

  // Props específicas para blog
  author?: any;
  pubDate?: Date;
  post?: any;

  // Props específicas para legal
  content?: string;
  canonicalURL?: string;
  noindex?: boolean;
}

const {
  pageTitle,
  description,
  image,
  keywords,
  robots,
  ctaTitle,
  ctaDescription,
  ctaButtonText,
  ctaButtonHref,
  variant = 'default',
  showBreadcrumb = true,
  showBackToTop = true,
  showWhatsApp = true,
  showTracking = true,
  showRecaptcha = false,
  author,
  pubDate,
  post,
  content,
  canonicalURL,
  noindex,
} = Astro.props;

// Configuración específica por variante
const variantConfig = {
  default: {
    showBreadcrumb: true,
    showBackToTop: true,
    showWhatsApp: true,
    showTracking: true,
    showRecaptcha: true,
  },
  blog: {
    showBreadcrumb: true,
    showBackToTop: true,
    showWhatsApp: true,
    showTracking: true,
    showRecaptcha: false,
  },
  legal: {
    showBreadcrumb: false,
    showBackToTop: false,
    showWhatsApp: true,
    showTracking: true,
    showRecaptcha: false,
  },
};

const config = variantConfig[variant];

// reCAPTCHA solo si está habilitado
const RECAPTCHA_SITE_KEY = showRecaptcha
  ? import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || null
  : null;
---

<html lang="es">
  <head>
    <BaseHead
      pageTitle={pageTitle}
      description={description}
      image={image}
      keywords={keywords}
      robots={robots}
    />
    {showTracking && <TrackingScripts />}
    <slot name="head" />
    {
      showRecaptcha && RECAPTCHA_SITE_KEY && (
        <script
          src={`https://www.google.com/recaptcha/api.js?render=${RECAPTCHA_SITE_KEY}`}
          defer
          is:inline
        />
      )
    }
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PJS922TG"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <TopBar />
    <Navbar />
    {showBreadcrumb && <Breadcrumb pageTitle={pageTitle} />}

    <slot />

    <Footer
      ctaTitle={ctaTitle}
      ctaDescription={ctaDescription}
      ctaButtonText={ctaButtonText}
      ctaButtonHref={ctaButtonHref}
    />
    {showBackToTop && <BackToTop />}
    {showWhatsApp && <WhatsAppButton />}

    <!-- Google Consent Mode - Para rastreo avanzado de consentimiento -->
    {showTracking && <GoogleConsentMode />}

    <!-- GDPR Manager - Siempre presente para gestionar consentimiento -->
    <GDPRManager />

    <!-- Meeting Wizard - Modal para agendamiento de citas -->
    <MeetingWizard />

    <script
      src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"
      defer></script>
  </body>
</html>

