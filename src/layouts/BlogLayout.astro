---
// src/layouts/BlogLayout.astro
// Layout para posts de blog que extiende BaseLayout

import BaseLayout from './BaseLayout.astro';
import FormattedDate from '@components/common/FormattedDate.astro';
import ReadingTime from '@components/common/ReadingTime.astro';
import { getCollection } from 'astro:content';
import SchemaMarkup from '@components/common/SchemaMarkup.astro';
import RecommendedServices from '@components/common/RecommendedServices.astro';
import SidebarFilters from '@components/sections/blog/SidebarFilters.astro';
import { services, type Service } from '@lib/constants/services';

const { pageTitle, description, keywords, image, author, pubDate, post } =
  Astro.props;

const allPosts = await getCollection('blog');

function getRelatedPosts(currentPost: any) {
  const relatedPosts = allPosts.filter((p: any) => {
    if (p.id === currentPost.id) return false;
    const currentCategories = Array.isArray(currentPost.category)
      ? currentPost.category
      : [currentPost.category];
    const postCategories = Array.isArray(p.category)
      ? p.category
      : [p.category];
    return currentCategories.some((cat: any) => postCategories.includes(cat));
  });
  return relatedPosts
    .sort(
      (a, b) =>
        new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
    )
    .slice(0, 4);
}

const relatedPosts = getRelatedPosts(post);
const hasRelated = relatedPosts && relatedPosts.length > 0;

// Genera la tabla de contenido dinámicamente como en LegalLayout
const headings = post.body.match(/<h[2-6].*?>(.*?)<\/h[2-6]>/g) || [];
const toc = headings.map((heading: string) => {
  const id =
    heading.match(/id="([^"]*)"/)?.[1] ||
    heading
      .replace(/<[^>]*>/g, '')
      .trim()
      .toLowerCase()
      .replace(/\s+/g, '-');
  return {
    text: heading.replace(/<[^>]*>/g, ''),
    id: id,
  };
});

// Datos para el sidebar
const categories = Array.from(
  new Set(allPosts.map((p: any) => p.data.category))
);
const tags = Array.from(
  new Set(
    allPosts.flatMap((p: any) =>
      Array.isArray(p.data.tags)
        ? p.data.tags
        : p.data.tags
          ? [p.data.tags]
          : []
    )
  )
);
const latestPosts = allPosts.slice(0, 5);

// Servicios destacados para el sidebar
const cornerstoneSlugs = [
  'diseno-desarrollo-web',
  'posicionamiento-seo',
  'publicidad-online-ia',
];

const featuredServices = services.filter((s: Service) =>
  cornerstoneSlugs.some((slug) => s.link.endsWith(slug))
);
---

<BaseLayout
  pageTitle={pageTitle}
  description={description}
  keywords={keywords}
  image={image}
  variant="blog"
  showBreadcrumb={true}
  showBackToTop={true}
  showWhatsApp={true}
  showTracking={true}
  showRecaptcha={false}
>
  <slot name="head">
    <SchemaMarkup post={post} />
  </slot>

  <main
    class="pt-8 pb-16 lg:pt-16 lg:pb-24 bg-white dark:bg-gray-900 antialiased overflow-x-hidden"
  >
    <div
      class="w-full max-w-screen-2xl mx-auto px-4 lg:px-8 grid grid-cols-1 lg:grid-cols-12 gap-8"
    >
      {/* Sidebar izquierdo (TOC como páginas legales) */}
      <aside class="hidden lg:block lg:col-span-2">
        <div class="sticky top-8">
          <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
            Tabla de Contenido
          </h2>
          <ul class="space-y-2">
            {
              toc.map((item: { id: string; text: string }) => (
                <li>
                  <a
                    href={`#${item.id}`}
                    class="block text-sm text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
                  >
                    {item.text}
                  </a>
                </li>
              ))
            }
          </ul>
        </div>
      </aside>

      {/* Contenido principal con línea divisoria */}
      <div class="col-span-1 lg:col-span-7 flex">
        {/* Línea divisoria entre TOC y artículo */}
        <div class="hidden lg:block w-px bg-gray-200 dark:bg-gray-700 mr-4 flex-shrink-0"></div>
        
        {/* Contenido del artículo */}
        <article class="w-full prose prose-lg dark:prose-invert mx-auto blog-content overflow-hidden">
          {/* Nueva estructura del artículo con diseño de tarjeta */}
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8 w-full">
            {/* Imagen de portada */}
            <div class="w-full">
              <img
                src={post.data.cover}
                alt={post.data.coverAlt || pageTitle}
                class="w-full h-64 object-cover rounded-t-2xl"
              />
            </div>

            {/* Contenido de la tarjeta */}
            <div class="p-6 bg-white">
              {/* Título del artículo */}
              <h1
                class="mb-4 text-3xl font-bold tracking-tight text-gray-900 dark:text-white"
              >
                {pageTitle}
              </h1>

              {/* Línea divisoria */}
              <div class="w-4/5 h-px bg-gray-200 mx-auto mb-6"></div>

              {/* Metadatos del artículo */}
              <div class="flex justify-between items-start mb-6">
                {/* Lado izquierdo - Información del autor */}
                <div class="flex items-center space-x-3">
                  <img
                    src={author.image.src || author.image}
                    alt={`Avatar de ${author.name}`}
                    width="64"
                    height="64"
                    class="w-16 h-16 rounded-xl object-cover"
                  />
                  <div class="space-y-1">
                    <div class="font-semibold text-gray-900 dark:text-white">
                      {author.name}
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                      {author.description}
                    </div>
                    <ReadingTime content={post.body} />
                  </div>
                </div>

                {/* Lado derecho - Información del artículo */}
                <div class="flex flex-col items-end space-y-2">
                  {/* Categoría y subcategoría */}
                  <div class="flex items-center space-x-2">
                    {
                      post.data.category && (
                        <span class="bg-gray-100 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded-full">
                          {post.data.category}
                        </span>
                      )
                    }
                    {
                      post.data.subcategory && (
                        <span class="text-primary-700 font-semibold text-xs">
                          / {post.data.subcategory}
                        </span>
                      )
                    }
                  </div>

                  {/* Fecha */}
                  <div class="flex items-center space-x-1 text-sm text-gray-500">
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                      ></path>
                    </svg>
                    <FormattedDate date={pubDate} />
                  </div>

                  {/* Iconos de redes sociales */}
                  <div class="flex gap-3">
                    {/* Facebook */}
                    <a
                      href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.toString())}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      aria-label="Compartir en Facebook"
                    >
                      <svg
                        width="20px"
                        height="20px"
                        stroke-width="1.5"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        color="#6b7280"
                      >
                        <path
                          d="M17 2H14C12.6739 2 11.4021 2.52678 10.4645 3.46447C9.52678 4.40215 9 5.67392 9 7V10H6V14H9V22H13V14H16L17 10H13V7C13 6.73478 13.1054 6.48043 13.2929 6.29289C13.4804 6.10536 13.7348 6 14 6H17V2Z"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                      </svg>
                    </a>
                    {/* LinkedIn */}
                    <a
                      href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.toString())}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      aria-label="Compartir en LinkedIn"
                    >
                      <svg
                        width="20px"
                        height="20px"
                        stroke-width="1.5"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        color="#6b7280"
                      >
                        <path
                          d="M21 8V16C21 18.7614 18.7614 21 16 21H8C5.23858 21 3 18.7614 3 16V8C3 5.23858 5.23858 3 8 3H16C18.7614 3 21 5.23858 21 8Z"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                        <path
                          d="M7 17V13.5V10"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                        <path
                          d="M11 17V13.75M11 10V13.75M11 13.75C11 10 17 10 17 13.75V17"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                        <path
                          d="M7 7.01L7.01 6.99889"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                      </svg>
                    </a>
                    {/* WhatsApp */}
                    <a
                      href={`https://wa.me/?text=${encodeURIComponent(pageTitle + ' ' + Astro.url.toString())}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      aria-label="Compartir en WhatsApp"
                    >
                      <svg
                        width="20px"
                        height="20px"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        color="#6b7280"
                      >
                        <path
                          d="M22 12C22 17.5228 17.5228 22 12 22C10.1786 22 8.47087 21.513 7 20.6622L2 21.5L2.83209 16C2.29689 14.7751 2 13.4222 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                        <path
                          d="M12.9604 13.8683L15.0399 13.4624L17 14.2149V16.0385C17 16.6449 16.4783 17.1073 15.8901 16.9783C14.3671 16.6444 11.5997 15.8043 9.67826 13.8683C7.84859 12.0248 7.22267 9.45734 7.01039 8.04128C6.92535 7.47406 7.3737 7 7.94306 7H9.83707L10.572 8.96888L10.1832 11.0701"
                          stroke="#6b7280"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"></path>
                      </svg>
                    </a>
                  </div>
                </div>
              </div>

              {/* Segunda línea divisoria */}
              <div class="w-4/5 h-px bg-gray-200 mx-auto mb-4"></div>
            </div>
          </div>

          {/* Contenido del artículo */}
          <div class="prose prose-lg dark:prose-invert max-w-none mt-8">
            <slot />
          </div>
        </article>
      </div>

      {/* Sidebar derecho (filtros del blog + servicios destacados) */}
      <aside class="hidden lg:block lg:col-span-3">
        <div class="sticky top-8 space-y-8">
          {/* Filtros del blog */}
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <form method="get" action="/blog" class="space-y-6">
              <div>
                <label
                  for="search"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1"
                  >Buscar</label
                >
                <input
                  id="search"
                  type="text"
                  name="q"
                  placeholder="Buscar por título, resumen..."
                  class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                  autocomplete="off"
                />
              </div>
              <div>
                <span
                  class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1"
                  >Categoría</span
                >
                <div class="space-y-1">
                  <label class="flex items-center gap-2">
                    <input type="radio" name="category" value="" checked />
                    Todas
                  </label>
                  {
                    categories &&
                      categories.length > 0 &&
                      categories.map((cat: string) => (
                        <label class="flex items-center gap-2">
                          <input type="radio" name="category" value={cat} />
                          {cat}
                        </label>
                      ))
                  }
                </div>
              </div>
              <div class="flex gap-2">
                <button
                  type="submit"
                  class="w-full py-2 px-4 bg-primary-600 text-white rounded hover:bg-primary-700 transition"
                >
                  Buscar
                </button>
                <a
                  href="/blog"
                  class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-center transition"
                >
                  Limpiar
                </a>
              </div>
            </form>
            <hr class="my-6 border-gray-200 dark:border-gray-700" />
            <section>
              <h3
                class="text-lg font-semibold mb-4 text-gray-900 dark:text-white"
              >
                Últimos artículos
              </h3>
              <ul class="space-y-3">
                {
                  latestPosts && latestPosts.length > 0 ? (
                    latestPosts.map((post: any) => (
                      <li>
                        <a
                          href={`/blog/${post.data.slug}`}
                          class="text-primary-700 dark:text-primary-400 hover:text-primary transition-colors font-medium text-sm"
                        >
                          {post.data.title}
                        </a>
                        <span class="block text-xs text-gray-400 dark:text-gray-500">
                          {post.data.pubDate?.toLocaleDateString?.() ?? ''}
                        </span>
                      </li>
                    ))
                  ) : (
                    <li class="text-gray-400 text-sm">
                      No hay artículos recientes.
                    </li>
                  )
                }
              </ul>
            </section>
          </div>

          {/* Servicios destacados */}
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3
              class="text-lg font-semibold mb-4 text-gray-900 dark:text-white"
            >
              Servicios Destacados
            </h3>
            <div class="space-y-4">
              {
                featuredServices.map((service: Service) => (
                  <div class="flex items-center space-x-3">
                    {/* Icono cuadrado redondeado */}
                    <a
                      href={service.link}
                      class="flex-shrink-0 w-12 h-12 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-primary-100 dark:hover:bg-primary-900 transition-colors"
                    >
                      <img
                        src={
                          typeof service.icon === 'string'
                            ? service.icon
                            : service.icon.src
                        }
                        alt={service.alt}
                        width="24"
                        height="24"
                        class="w-6 h-6 object-contain"
                      />
                    </a>
                    {/* Nombre del servicio */}
                    <a
                      href={service.link}
                      class="text-sm font-medium text-gray-900 dark:text-white hover:text-primary-600 dark:hover:text-primary-400 transition-colors flex-1"
                    >
                      {service.title}
                    </a>
                  </div>
                ))
              }
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>
</BaseLayout>

<style>
  /* Estilos para el TOC como en páginas legales */
  .blog-content h2,
  .blog-content h3,
  .blog-content h4,
  .blog-content h5,
  .blog-content h6 {
    scroll-margin-top: 2rem;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>
